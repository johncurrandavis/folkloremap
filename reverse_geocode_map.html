<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8" />
  <title>Reverse Geocoding</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet & Plugins CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

  <!-- bootstrap / icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <!-- AOS (animate on scroll) -->
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">

  <link rel="stylesheet" href="./style.css" />

  <style>

    :root {
      --dark_brown: #210;
      --light_brown: #bb7;
      --pale_green: #deb;
      --darkish_green: #465;

    }

    html, body {
      margin: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #app {
      display: flex;
      flex-direction: row;
      height: 100%;
    }

    #sidebar {
      width: 300px;
      min-width: 240px;
      max-width: 400px;
      background: #f9f9f9;
      border-right: 1px solid #ccc;
      padding: 1rem;
      box-sizing: border-box;
      overflow-y: auto;
    }

    #map {
      flex: 1;
      height: 100%;
    }

    .custom-button {
      display: block;
      margin-top: 10px;
      padding: 8px 12px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      width: 100%;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    }

    .custom-button:hover {
      background: #f0f0f0;
    }

    #loading {
      font-size: 0.9em;
      color: #777;
      display: none;
      margin-bottom: 1em;
    }

    @media (max-width: 768px) {
      #app {
        flex-direction: column;
      }

      #sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid #ccc;
      }
    }

  </style>

</head>

<body>

<!-- navbar -->

<nav class="navbar navbar-expand-lg sticky-top shadow-sm"
      style = "background-color: #210; color: #deb;">
  <div class="container">

    <a href="./folklore_map.html" class="btn btn-md m-1">Folklore map</a>

    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">

      <ul class="navbar-nav">
        <li class="nav-item">
          <a href="./contact.html" class="btn btn-md m-1">Contact</a>
        </li>
        <li class="nav-item">
          <a href="./index.html" class="btn btn-md m-1">Home</a>
        </li>

        <!--
        <li class="nav-item">
          <button id="toggleTheme" class="btn btn-outline-secondary ms-3 theme-toggle" title="Toggle Theme">
            <i class="bi bi-moon-fill"></i>
          </button>
        </li>
        -->

      </ul>

    </div>  <!-- end collapse -->
  </div>  <!-- end container -->
</nav>

<div id="app">

  <div id="sidebar">
    <h2>Location Info</h2>
    <div id="loading">Loading...</div>
    <div id="addressInfo">Click the map or search to get location info.</div>
    <button id="clearBtn" class="custom-button">Clear Map</button>
    <button id="toggleBtn" class="custom-button">Allow Multiple Markers</button>
    <button id="downloadBtn" class="custom-button">Download Locations (CSV)</button>
  </div>

  <div id="map"></div>

</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script>
  // Initialize the map centered on Stonehenge
  const map = L.map('map').setView([51.17883, -1.82618], 22);

  // Add the base map layer
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
  }).addTo(map);

  // DOM elements
  const addressInfo = document.getElementById('addressInfo');
  const loading = document.getElementById('loading');
  const clearBtn = document.getElementById('clearBtn');
  const toggleBtn = document.getElementById('toggleBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  let currentMarker = null;
  let currentPolygon = null;
  let markers = [];
  let allowMultiple = false;

  // Marker cluster group
  const markerClusterGroup = L.markerClusterGroup().addTo(map);

  // Create custom icons
  const customIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
    iconSize: [32, 32],
    iconAnchor: [16, 32],
    popupAnchor: [0, -30]
  });






  const nominatim = new L.Control.Geocoder.Nominatim({
    geocodingQueryParams: { countrycodes: 'gb' }
  });

  const geocoderControl = L.Control.geocoder({
    defaultMarkGeocode: false,
    geocoder: nominatim
  })
  .on('markgeocode', function(e) {
    const center = e.geocode.center;
    const bbox = e.geocode.bbox;

    handleLocation(center.lat, center.lng, e.geocode.name, bbox);

    if (bbox) {
      map.fitBounds(bbox);
    } else {
      map.setView(center, 16); // fallback zoom
    }
  })
  .addTo(map);

  map.on('click', function(e) {
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;

    if (!allowMultiple) clearMap();

    loading.style.display = 'block';

    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&email=test@example.com`)
      .then(res => res.json())
      .then(data => {
        loading.style.display = 'none';
        const label = data.display_name || 'Unknown location';
        handleLocation(lat, lon, label, null);
      })
      .catch(() => {
        loading.style.display = 'none';
        addressInfo.innerHTML = '⚠️ Reverse geocoding failed.';
      });
  });



  function handleLocation(lat, lon, label, bbox) {
    if (!allowMultiple) clearMap();

    const marker = L.marker([lat, lon], { icon: customIcon })
      .bindPopup(`<strong>${label}</strong><br>Lat: ${lat.toFixed(5)}, Lng: ${lon.toFixed(5)}`)
      .openPopup();

    markerClusterGroup.addLayer(marker);

    if (allowMultiple) {
      markers.push({ lat, lon, label });
    } else {
      currentMarker = marker;
      markers = [{ lat, lon, label }];
    }

    addressInfo.innerHTML = `<strong>${label}</strong><br>Lat: ${lat.toFixed(5)}, Lng: ${lon.toFixed(5)}`;

    if (bbox && !allowMultiple) {
      currentPolygon = L.polygon([
        bbox.getSouthEast(),
        bbox.getNorthEast(),
        bbox.getNorthWest(),
        bbox.getSouthWest()
      ], { color: 'blue', weight: 1, fillOpacity: 0.1 }).addTo(map);
    }
  }

  function clearMap() {
    if (currentMarker) {
      map.removeLayer(currentMarker);
      currentMarker = null;
    }
    if (currentPolygon) {
      map.removeLayer(currentPolygon);
      currentPolygon = null;
    }
    markerClusterGroup.clearLayers();
    markers = [];
    addressInfo.innerHTML = 'Map cleared.';
  }

  function downloadCSV() {
    if (markers.length === 0) {
      alert('No markers to export.');
      return;
    }
    const header = 'Label,Latitude,Longitude\n';
    const rows = markers.map(m => `"${m.label.replace(/"/g, '""')}",${m.lat},${m.lon}`).join('\n');
    const csv = header + rows;
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = 'locations.csv';
    a.click();

    URL.revokeObjectURL(url);
  }

  clearBtn.onclick = clearMap;

  toggleBtn.onclick = () => {
    allowMultiple = !allowMultiple;
    toggleBtn.innerText = allowMultiple ? 'Only One Marker' : 'Allow Multiple Markers';
  };

  downloadBtn.onclick = downloadCSV;
</script>

</body>
</html>